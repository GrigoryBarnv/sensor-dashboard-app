<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Test-Modus Sensoren</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .sensor-button {
      width: 48%;
      margin: 0.5%;
    }
    .chart-container {
      width: 100%;
      height: 400px;
    }
    .dot {
      height: 10px;
      width: 10px;
      background-color: red;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Test-Modus</h2>
      <a href="/live" class="btn btn-sm btn-outline-danger">
        <span class="dot"></span> Zur√ºck zur Live-Ansicht
      </a>
    </div>

    <div class="mb-4">
      <div class="d-flex flex-wrap justify-content-between">
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ2">MQ2</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ3_1">MQ3_1</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ3_10">MQ3_10</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ4">MQ4</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ5">MQ5</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ6">MQ6</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ8">MQ8</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ9">MQ9</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ135">MQ135</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ136">MQ136</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ137">MQ137</button>
        <button class="btn btn-outline-primary sensor-button" data-sensor-id="MQ138">MQ138</button>
      </div>
    </div>

    <div id="plot" class="chart-container"></div>
  </div>

  <script>
    const sensorColors = {
      MQ2: "red", MQ3_1: "orange", MQ3_10: "gold",
      MQ4: "green", MQ5: "blue", MQ6: "purple",
      MQ8: "teal", MQ9: "pink", MQ135: "brown",
      MQ136: "cyan", MQ137: "gray", MQ138: "magenta"
    };

    function redrawPlotLive(sensorId, data, color) {
      const plotDiv = document.getElementById('plot');
      const timeArray = data.time;
      const valueArray = data.values;

      let index = 0;
      const trace = {
        x: [],
        y: [],
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: color },
        name: sensorId
      };

      Plotly.newPlot(plotDiv, [trace], {
        title: "Live Sensorverlauf",
        xaxis: { title: 'Zeit' },
        yaxis: { title: 'Sensorwert (Ohm)' },
        margin: { t: 40 }
      });

      function step() {
        if (index >= timeArray.length) {
          index = 0;
          trace.x = [];
          trace.y = [];
          Plotly.newPlot(plotDiv, [trace]);
          setTimeout(step, 500);
          return;
        }
        trace.x.push(timeArray[index]);
        trace.y.push(valueArray[index]);
        Plotly.extendTraces(plotDiv, { x: [[timeArray[index]]], y: [[valueArray[index]]] }, [0]);
        index++;
        setTimeout(step, 500);
      }
      step();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".sensor-button");
      buttons.forEach(button => {
        button.addEventListener("click", () => {
          const sensorId = button.getAttribute("data-sensor-id");
          fetch(`/api/sensor/${sensorId}`)
            .then(res => res.json())
            .then(data => {
              if (data.error) {
                alert("Fehler: " + data.error);
                return;
              }
              const color = sensorColors[sensorId] || 'black';
              buttons.forEach(b => {
                b.style.backgroundColor = "";
                b.style.color = "";
              });
              button.style.backgroundColor = color;
              button.style.color = 'white';
              redrawPlotLive(sensorId, data, color);
            });
        });
      });
    });
  </script>
</body>
</html>
